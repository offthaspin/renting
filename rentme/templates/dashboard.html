{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container my-4">
  <h2 class="fw-bold mb-4">üè† Rentana Dashboard</h2>

  <!-- ===== Stats Cards ===== -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Tenants</h6>
        <h2 id="total-tenants">0</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Expected</h6>
        <h2 id="total-expected">0</h2>
        <div class="progress mt-2">
          <div id="expected-progress" class="progress-bar bg-primary" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Collected</h6>
        <h2 id="total-collected">0</h2>
        <div class="progress mt-2">
          <div id="collected-progress" class="progress-bar bg-success" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Outstanding</h6>
        <h2 id="total-outstanding">0</h2>
        <div class="progress mt-2">
          <div id="outstanding-progress" class="progress-bar bg-danger" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Sidebar Link to Payment Settings ===== -->
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('landlord_settings.settings_payment') }}"> 
      üí≥ Payment Settings
    </a>
  </li>

  <!-- ===== Tenants Table ===== -->
  <div class="glass p-3 mb-4">
    <h5 class="mb-3">Tenants</h5>
    <div class="table-responsive">
      <table class="futuristic-table" id="tenants-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>House No</th>
            <th>Monthly Rent</th>
            <th>Total Paid</th>
            <th>Total Due</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Scripts ===== -->
<script>
// ---- Smooth number animation ----
function animateNumber(el, value) {
  let current = parseFloat(el.innerText.replace(/,/g,'')) || 0;
  const diff = value - current;
  const step = diff / 20;
  let i = 0;
  const interval = setInterval(() => {
    current += step;
    el.innerText = Math.round(current).toLocaleString();
    i++;
    if (i >= 20) {
      el.innerText = value.toLocaleString();
      clearInterval(interval);
    }
  }, 25);
}

// ---- Load dashboard initially ----
async function loadDashboard() {
  try {
    const res = await fetch("{{ url_for('dashboard_data') }}");
    const data = await res.json();
    updateDashboardUI(data);
  } catch (err) {
    console.error("‚ùå Error loading dashboard:", err);
  }
}

// ---- Update dashboard UI ----
function updateDashboardUI(data) {
  animateNumber(document.getElementById("total-tenants"), data.total_tenants);
  animateNumber(document.getElementById("total-expected"), data.total_expected);
  animateNumber(document.getElementById("total-collected"), data.total_collected);
  animateNumber(document.getElementById("total-outstanding"), data.total_outstanding);

  const percent = data.collected_percent || 0;
  document.getElementById("expected-progress").style.width = `${percent}%`;
  document.getElementById("collected-progress").style.width = `${percent}%`;
  document.getElementById("outstanding-progress").style.width = `${100 - percent}%`;

  // ---- Tenants table ----
  const tenantsTable = document.querySelector("#tenants-table tbody");
  tenantsTable.innerHTML = "";
  data.tenants.forEach(t => {
    tenantsTable.innerHTML += `
      <tr data-tenant-id="${t.id}">
        <td>${t.name}</td>
        <td>${t.phone}</td>
        <td>${t.house_no}</td>
        <td>${t.monthly_rent.toLocaleString()}</td>
        <td class="amount-paid">${t.total_paid.toLocaleString()}</td>
        <td>${t.total_due.toLocaleString()}</td>
        <td class="balance">
          <span class="${t.balance < 0 ? 'text-danger' : 'text-success'}">
            ${t.formatted_balance || t.balance.toLocaleString()}
          </span>
        </td>
      </tr>`;
  });
}

// ---- Initial load + refresh every 15s ----
loadDashboard();
setInterval(loadDashboard, 15000);
</script>
{% endblock %}
