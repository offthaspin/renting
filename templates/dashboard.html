{% extends "base.html" %}
{% block content %}
<div class="container my-4">
  <h2 class="fw-bold mb-4">üè† Rentana Dashboard</h2>

  <!-- ===== Stats Cards ===== -->
  <div class="row g-4 mb-4">
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Tenants</h6>
        <h2 id="total-tenants">0</h2>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Expected</h6>
        <h2 id="total-expected">0</h2>
        <div class="progress mt-2">
          <div id="expected-progress" class="progress-bar bg-primary" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Collected</h6>
        <h2 id="total-collected">0</h2>
        <div class="progress mt-2">
          <div id="collected-progress" class="progress-bar bg-success" style="width:0%"></div>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="glass text-center p-4">
        <h6>Total Outstanding</h6>
        <h2 id="total-outstanding">0</h2>
        <div class="progress mt-2">
          <div id="outstanding-progress" class="progress-bar bg-danger" style="width:0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Sidebar Link to Payment Settings ===== -->
  <li class="nav-item">
    <a class="nav-link" href="{{ url_for('landlord_settings.settings_payment') }}">
      üí≥ Payment Settings
    </a>
  </li>

  <!-- ===== Tenants Table ===== -->
  <div class="glass p-3 mb-4">
    <h5 class="mb-3">Tenants</h5>
    <div class="table-responsive">
      <table class="futuristic-table" id="tenants-table">
        <thead>
          <tr>
            <th>Name</th>
            <th>Phone</th>
            <th>House No</th>
            <th>Monthly Rent</th>
            <th>Total Paid</th>
            <th>Total Due</th>
            <th>Balance</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== Recent Payments ===== -->
  <div class="glass p-3">
    <h5 class="mb-3">Recent Payments</h5>
    <div class="table-responsive">
      <table class="futuristic-table" id="payments-table">
        <thead>
          <tr>
            <th>Tenant</th>
            <th>Amount</th>
            <th>Note</th>
            <th>Paid At</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<!-- ===== Scripts ===== -->
<script>
// ---- Helper for smooth number animation ----
function animateNumber(el, value) {
  let current = parseFloat(el.innerText.replace(/,/g,'')) || 0;
  const diff = value - current;
  const step = diff / 20;
  let i = 0;
  const interval = setInterval(() => {
    current += step;
    el.innerText = Math.round(current).toLocaleString();
    i++;
    if (i >= 20) {
      el.innerText = value.toLocaleString();
      clearInterval(interval);
    }
  }, 25);
}

// ---- Load dashboard initially ----
async function loadDashboard() {
  try {
    const res = await fetch("{{ url_for('dashboard_data') }}");
    const data = await res.json();
    updateDashboardUI(data);
  } catch (err) {
    console.error("‚ùå Error loading dashboard:", err);
  }
}

// ---- Update dashboard UI ----
function updateDashboardUI(data) {
  animateNumber(document.getElementById("total-tenants"), data.total_tenants);
  animateNumber(document.getElementById("total-expected"), data.total_expected);
  animateNumber(document.getElementById("total-collected"), data.total_collected);
  animateNumber(document.getElementById("total-outstanding"), data.total_outstanding);

  const percent = data.collected_percent || 0;
  document.getElementById("expected-progress").style.width = `${percent}%`;
  document.getElementById("collected-progress").style.width = `${percent}%`;
  document.getElementById("outstanding-progress").style.width = `${100 - percent}%`;

  // ---- Tenants table ----
  const tenantsTable = document.querySelector("#tenants-table tbody");
  tenantsTable.innerHTML = "";
  data.tenants.forEach(t => {
    tenantsTable.innerHTML += `
      <tr data-tenant-id="${t.id}">
        <td>${t.name}</td>
        <td>${t.phone}</td>
        <td>${t.house_no}</td>
        <td>${t.monthly_rent.toLocaleString()}</td>
        <td class="amount-paid">${t.total_paid.toLocaleString()}</td>
        <td>${t.total_due.toLocaleString()}</td>
        <td class="balance">${t.balance.toLocaleString()}</td>
      </tr>`;
  });

  // ---- Recent payments table ----
  const paymentsTable = document.querySelector("#payments-table tbody");
  paymentsTable.innerHTML = "";
  data.payments.forEach(p => {
    paymentsTable.innerHTML += `
      <tr>
        <td>${p.tenant_name}</td>
        <td>${p.amount.toLocaleString()}</td>
        <td>${p.note}</td>
        <td>${p.paid_at}</td>
      </tr>`;
  });
}

// ---- Initial Load ----
loadDashboard();
setInterval(loadDashboard, 15000);

// ---- Real-time updates via Socket.IO ----
const socketScript = document.createElement('script');
socketScript.src = "https://cdn.socket.io/4.7.5/socket.io.min.js";
socketScript.onload = () => {
  const socket = io();

  socket.on("connect", () => console.log("‚úÖ Connected to Socket.IO"));
  socket.on("disconnect", () => console.warn("‚ö†Ô∏è Socket.IO disconnected"));

  socket.on("payment_update", (data) => {
    console.log("üí∞ Real-time payment:", data);

    // ‚úÖ Update totals
    if (data.totals) {
      animateNumber(document.getElementById("total-collected"), data.totals.collected);
      animateNumber(document.getElementById("total-outstanding"), data.totals.outstanding);
    }

    // ‚úÖ Update tenant row visually
    const row = document.querySelector(`[data-tenant-id="${data.tenant_id}"]`);
    if (row) {
      const paidCell = row.querySelector(".amount-paid");
      const balanceCell = row.querySelector(".balance");
      if (paidCell) paidCell.innerText = parseFloat(data.new_total_paid).toLocaleString();
      if (balanceCell) balanceCell.innerText = parseFloat(data.new_balance).toLocaleString();

      // üí° Flash effect for visibility
      row.classList.add("table-success");
      row.style.transition = "background-color 0.5s ease";
      setTimeout(() => row.classList.remove("table-success"), 3000);
    }

    // ‚úÖ Add payment to recent table
    const paymentsTable = document.querySelector("#payments-table tbody");
    const newRow = document.createElement("tr");
    newRow.innerHTML = `
      <td>${data.tenant_name}</td>
      <td>${data.amount.toLocaleString()}</td>
      <td>${data.note || ""}</td>
      <td>${data.paid_at || new Date().toLocaleString()}</td>`;
    paymentsTable.prepend(newRow);
    while (paymentsTable.rows.length > 10) paymentsTable.deleteRow(10);

    // ‚úÖ Toast message
    const toast = document.createElement("div");
    toast.className = "toast align-items-center text-bg-success border-0 position-fixed top-0 end-0 m-3";
    toast.style.zIndex = 9999;
    toast.innerHTML = `
      <div class="d-flex">
        <div class="toast-body">
          üí∏ Payment received: Ksh ${data.amount.toLocaleString()} from ${data.msisdn || data.tenant_name}!
        </div>
        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
      </div>`;
    document.body.appendChild(toast);
    if (window.bootstrap && bootstrap.Toast) {
      new bootstrap.Toast(toast, { delay: 4000 }).show();
    } else {
      alert(`üí∏ Payment received: ${data.amount.toLocaleString()} from ${data.msisdn || data.tenant_name}!`);
    }
  });
};
document.body.appendChild(socketScript);
</script>
{% endblock %}
